{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "registerAppName": {
      "type": "string"
    },
    "manageAppName": {
      "type": "string"
    },
    "sandboxAppName": {
      "type": "string"
    },
    "appHostingPlanName": {
      "type": "string"
    },
    "appHostingEnvironment": {
      "type": "string",
      "defaultValue": ""
    },
    "appServerFarmResourceGroup": {
      "type": "string"
    },
    "aspLocation": {
      "type": "string",
      "allowedValues": [
        "North Europe",
        "West Europe"
      ],
      "defaultValue": "West Europe"
    },
    "LoggingRedisConnectionString": {
      "type": "securestring"
    },
    "AvmsPlusDatabaseConnectionString": {
      "type": "securestring"
    },
    "EnvironmentName": {
      "type": "string"
    },
    "LoggingRedisKey": {
      "type": "string"
    },
    "ApprenticeshipInfoApiBaseUrl": {
      "type": "string"
    },
    "LiveApprenticeshipVacancyBaseUrl": {
      "type": "string"
    },
    "VacancySearchUrl": {
      "type": "string"
    },
    "ApprenticeshipIndexAlias": {
      "type": "string"
    },
    "LiveTraineeshipVacancyBaseUrl": {
      "type": "string"
    },
    "CacheConnectionString": {
      "type": "securestring"
    },
    "CacheReferenceDataDuration": {
      "type": "string"
    },
    "RecruitMongoConnectionString": {
      "type": "securestring"
    },
    "RecruitMongoDatabaseName": {
      "type": "string"
    },
    "RecruitMongoCollectionName": {
      "type": "string"
    },
    "registerKeyVaultCertificateName": {
      "type": "string",
      "defaultValue": ""
    },
    "manageKeyVaultCertificateName": {
      "type": "string",
      "defaultValue": ""
    },
    "sandboxKeyVaultCertificateName": {
      "type": "string",
      "defaultValue": ""
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": ""
    },
    "keyVaultResourceGroup": {
      "type": "string",
      "defaultValue": ""
    },
    "registerAppDomainName": {
      "type": "string",
      "defaultValue": ""
    },
    "manageAppDomainName": {
      "type": "string",
      "defaultValue": ""
    },
    "sandboxAppDomainName": {
      "type": "string",
      "defaultValue": ""
    },
    "ElasticsearchUserName": {
      "type": "string",
      "defaultValue": ""
    },
    "ElasticsearchPassword": {
      "type": "securestring",
      "defaultValue": ""
    },
    "aspSize": {
      "type": "string",
      "defaultValue": "1"
    },
    "aspInstances": {
      "type": "int",
      "defaultValue": 1
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": ""
    },
    "ipSecurityRestrictions": {
      "type": "array",
      "defaultValue": []
    },
    "resourceEnvironmentName": {
      "type": "string",
      "defaultValue": ""
    },
    "serviceName": {
      "type": "string",
      "defaultValue": ""
    },
    "aseHostingEnvironmentName": {
        "type": "string",
        "defaultValue": ""
    },
    "aseResourceGroup": {
        "type": "string",
        "defaultValue": ""
    }
  },
  "variables": {
    "deploymentUrlBase": "https://raw.githubusercontent.com/SkillsFundingAgency/das-platform-building-blocks/master/templates/",
    "instancePrefix": "[if(equals(toUpper(parameters('EnvironmentName')),'PROD'),'',parameters('EnvironmentName'))]",
    "resourceNamePrefix": "[toLower(concat('das-', parameters('resourceEnvironmentName'),'-', parameters('serviceName')))]",
    "apiAppServicePlanName": "[concat(variables('resourceNamePrefix'), 'api-asp')]",
    "sandboxName": "[if(equals(length(variables('instancePrefix')),0),'(Sandbox)',concat(variables('instancePrefix'),' (Sandbox)'))]",
    "Environment": "[if(equals(toUpper(parameters('EnvironmentName')),'PREPROD'),'PP',parameters('EnvironmentName'))]",
    "deployToASE": "[greater(length(parameters('appHostingEnvironment')), 0)]"
  },
  "resources": [{
      "apiVersion": "2017-05-10",
      "name": "app-service-plan",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'), 'app-service-plan.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appServicePlanName": {
            "value": "[variables('apiAppServicePlanName')]"
          },
          "aspSize": {
            "value": "1"
          },
          "aspInstances": {
            "value": 1
          },
          "aseHostingEnvironmentName": {
            "value": "[parameters('aseHostingEnvironmentName')]"
          },
          "aseResourceGroup": {
            "value": "[parameters('aseResourceGroup')]"
          }
        }
      }
    },
    {
      "condition": "[greater(length(parameters('registerKeyVaultCertificateName')), 0)]",
      "apiVersion": "2017-08-01",
      "name": "register-api-app-service-certificate",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'app-service-certificate.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultCertificateName": {
            "value": "[parameters('registerKeyVaultCertificateName')]"
          },
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "keyVaultResourceGroup": {
            "value": "[parameters('keyVaultResourceGroup')]"
          }
        }
      },
      "dependsOn": []
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[parameters('registerAppName')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'app-service.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appServiceName": {
            "value": "[parameters('registerAppName')]"
          },
          "appServicePlanName": {
            "value": "[parameters('appHostingPlanName')]"
          },
          "appServicePlanResourceGroup": {
            "value": "[parameters('appServerFarmResourceGroup')]"
          },
          "appServiceAppSettings": {
            "value": [{
                "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                "value": "[reference(concat(parameters('registerAppName'),'-ai')).outputs.InstrumentationKey.value]"
              },
              {
                "name": "LoggingRedisConnectionString",
                "value": "[parameters('LoggingRedisConnectionString')]"
              },
              {
                "name": "AvmsPlusDatabaseConnectionString",
                "value": "[parameters('AvmsPlusDatabaseConnectionString')]"
              },
              {
                "name": "EnvironmentName",
                "value": "[parameters('EnvironmentName')]"
              },
              {
                "name": "LoggingRedisKey",
                "value": "[parameters('LoggingRedisKey')]"
              },
              {
                "name": "ApprenticeshipInfoApiBaseUrl",
                "value": "[parameters('ApprenticeshipInfoApiBaseUrl')]"
              },
              {
                "name": "CacheConnectionString",
                "value": "[parameters('CacheConnectionString')]"
              },
              {
                "name": "UseSandboxServices",
                "value": "no"
              },
              {
                "name": "CacheReferenceDataDuration",
                "value": "[parameters('CacheReferenceDataDuration')]"
              },
              {
                "name": "LiveApprenticeshipVacancyBaseUrl",
                "value": "[parameters('LiveApprenticeshipVacancyBaseUrl')]"
              },
              {
                "name": "VacancySearchUrl",
                "value": "[parameters('VacancySearchUrl')]"
              },
              {
                "name": "ApprenticeshipIndexAlias",
                "value": "[parameters('ApprenticeshipIndexAlias')]"
              },
              {
                "name": "LiveTraineeshipVacancyBaseUrl",
                "value": "[parameters('LiveTraineeshipVacancyBaseUrl')]"
              },
              {
                "name": "RecruitMongoConnectionString",
                "value": "[parameters('RecruitMongoConnectionString')]"
              },
              {
                "name": "RecruitMongoDatabaseName",
                "value": "[parameters('RecruitMongoDatabaseName')]"
              },
              {
                "name": "RecruitMongoCollectionName",
                "value": "[parameters('RecruitMongoCollectionName')]"
              },
              {
                "name": "InstanceName",
                "value": "[variables('instancePrefix')]"
              },
              {
                "name": "ElasticsearchUserName",
                "value": "[parameters('ElasticsearchUserName')]"
              },
              {
                "name": "ElasticsearchPassword",
                "value": "[parameters('ElasticsearchPassword')]"
              }
            ]
          },
          "customHostName": {
            "value": "[parameters('registerAppDomainName')]"
          },
          "certificateThumbprint": {
            "value": "[if(greater(length(parameters('registerKeyVaultCertificateName')), 0), reference('register-api-app-service-certificate', '2018-11-01').outputs.certificateThumbprint.value, '')]"
          },
          "appKind": {
            "value": "api"
          },
          "ipSecurityRestrictions": {
            "value": "[parameters('ipSecurityRestrictions')]"
          }
        }
      },
      "dependsOn": [
        "[concat(parameters('registerAppName'),'-ai')]",
        "app-service-plan"
      ]
    },
    {
      "apiVersion": "2017-08-01",
      "name": "[concat(parameters('registerAppName'),'-ai')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'application-insights.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appInsightsName": {
            "value": "[parameters('registerAppName')]"
          },
          "attachedService": {
            "value": "[parameters('registerAppName')]"
          }
        }
      },
      "dependsOn": []
    },
    {
      "condition": "[greater(length(parameters('manageKeyVaultCertificateName')), 0)]",
      "apiVersion": "2017-08-01",
      "name": "manage-api-app-service-certificate",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'app-service-certificate.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultCertificateName": {
            "value": "[parameters('manageKeyVaultCertificateName')]"
          },
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "keyVaultResourceGroup": {
            "value": "[parameters('keyVaultResourceGroup')]"
          }
        }
      },
      "dependsOn": []
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[parameters('manageAppName')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'app-service.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appServiceName": {
            "value": "[parameters('manageAppName')]"
          },
          "appServicePlanName": {
            "value": "[parameters('appHostingPlanName')]"
          },
          "appServicePlanResourceGroup": {
            "value": "[parameters('appServerFarmResourceGroup')]"
          },
          "appServiceAppSettings": {
            "value": [{
                "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                "value": "[reference(concat(parameters('manageAppName'),'-ai')).outputs.InstrumentationKey.value]"
              },
              {
                "name": "LoggingRedisConnectionString",
                "value": "[parameters('LoggingRedisConnectionString')]"
              },
              {
                "name": "AvmsPlusDatabaseConnectionString",
                "value": "[parameters('AvmsPlusDatabaseConnectionString')]"
              },
              {
                "name": "EnvironmentName",
                "value": "[parameters('EnvironmentName')]"
              },
              {
                "name": "LoggingRedisKey",
                "value": "[parameters('LoggingRedisKey')]"
              },
              {
                "name": "ApprenticeshipInfoApiBaseUrl",
                "value": "[parameters('ApprenticeshipInfoApiBaseUrl')]"
              },
              {
                "name": "CacheConnectionString",
                "value": "[parameters('CacheConnectionString')]"
              },
              {
                "name": "UseSandboxServices",
                "value": "no"
              },
              {
                "name": "InstanceName",
                "value": "[variables('instancePrefix')]"
              },
              {
                "name": "CacheReferenceDataDuration",
                "value": "[parameters('CacheReferenceDataDuration')]"
              }
            ]
          },
          "customHostName": {
            "value": "[parameters('manageAppDomainName')]"
          },
          "certificateThumbprint": {
            "value": "[if(greater(length(parameters('manageKeyVaultCertificateName')), 0), reference('manage-api-app-service-certificate', '2018-11-01').outputs.certificateThumbprint.value, '')]"
          },
          "appKind": {
            "value": "api"
          }
        }
      },
      "dependsOn": [
        "[concat(parameters('manageAppName'),'-ai')]",
        "app-service-plan"
      ]
    },
    {
      "apiVersion": "2017-08-01",
      "name": "[concat(parameters('manageAppName'),'-ai')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'application-insights.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appInsightsName": {
            "value": "[parameters('manageAppName')]"
          },
          "attachedService": {
            "value": "[parameters('manageAppName')]"
          }
        }
      },
      "dependsOn": []
    },
    {
      "condition": "[greater(length(parameters('sandboxKeyVaultCertificateName')), 0)]",
      "apiVersion": "2017-08-01",
      "name": "sandbox-api-app-service-certificate",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'app-service-certificate.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "keyVaultCertificateName": {
            "value": "[parameters('sandboxKeyVaultCertificateName')]"
          },
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "keyVaultResourceGroup": {
            "value": "[parameters('keyVaultResourceGroup')]"
          }
        }
      },
      "dependsOn": []
    },
    {
      "apiVersion": "2017-05-10",
      "name": "[parameters('sandboxAppName')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'app-service.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appServiceName": {
            "value": "[parameters('sandboxAppName')]"
          },
          "appServicePlanName": {
            "value": "[parameters('appHostingPlanName')]"
          },
          "appServicePlanResourceGroup": {
            "value": "[parameters('appServerFarmResourceGroup')]"
          },
          "appServiceAppSettings": {
            "value": [{
                "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                "value": "[reference(concat(parameters('sandboxAppName'),'-ai')).outputs.InstrumentationKey.value]"
              },
              {
                "name": "LoggingRedisConnectionString",
                "value": "[parameters('LoggingRedisConnectionString')]"
              },
              {
                "name": "AvmsPlusDatabaseConnectionString",
                "value": "[parameters('AvmsPlusDatabaseConnectionString')]"
              },
              {
                "name": "EnvironmentName",
                "value": "[parameters('EnvironmentName')]"
              },
              {
                "name": "LoggingRedisKey",
                "value": "[parameters('LoggingRedisKey')]"
              },
              {
                "name": "ApprenticeshipInfoApiBaseUrl",
                "value": "[parameters('ApprenticeshipInfoApiBaseUrl')]"
              },
              {
                "name": "CacheConnectionString",
                "value": "[parameters('CacheConnectionString')]"
              },
              {
                "name": "UseSandboxServices",
                "value": "yes"
              },
              {
                "name": "InstanceName",
                "value": "[variables('sandboxName')]"
              },
              {
                "name": "CacheReferenceDataDuration",
                "value": "[parameters('CacheReferenceDataDuration')]"
              }
            ]
          },
          "customHostName": {
            "value": "[parameters('sandboxAppDomainName')]"
          },
          "certificateThumbprint": {
            "value": "[if(greater(length(parameters('sandboxKeyVaultCertificateName')), 0), reference('sandbox-api-app-service-certificate', '2018-11-01').outputs.certificateThumbprint.value, '')]"
          },
          "appKind": {
            "value": "api"
          }
        }
      },
      "dependsOn": [
        "[concat(parameters('sandboxAppName'),'-ai')]",
        "app-service-plan"
      ]
    },
    {
      "apiVersion": "2017-08-01",
      "name": "[concat(parameters('sandboxAppName'),'-ai')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'application-insights.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "appInsightsName": {
            "value": "[parameters('sandboxAppName')]"
          },
          "attachedService": {
            "value": "[parameters('sandboxAppName')]"
          }
        }
      },
      "dependsOn": []
    },
    {
      "apiVersion": "2017-08-01",
      "name": "[parameters('storageAccountName')]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('deploymentUrlBase'),'storage-account-arm.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          }
        }
      },
      "dependsOn": []
    }
  ],
  "outputs": {}
}